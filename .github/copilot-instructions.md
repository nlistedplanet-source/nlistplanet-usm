# Copilot Instructions — NListPlanet / UnlistedHub

- Architecture: One shared backend in [UnlistedHub-USM/backend](UnlistedHub-USM/backend) serves both desktop [UnlistedHub-USM/frontend](UnlistedHub-USM/frontend) and mobile PWA [nlistplanet-mobile/frontend](nlistplanet-mobile/frontend); treat any docs claiming a separate mobile backend as legacy. Backend is ES modules only (no require).
- Must-read files: security and route wiring in [backend/server.js](UnlistedHub-USM/backend/server.js); auth helpers in [backend/middleware/auth.js](UnlistedHub-USM/backend/middleware/auth.js); listing schema and fee fields in [backend/models/Listing.js](UnlistedHub-USM/backend/models/Listing.js); company schema uses `name` field with pre-save hook that auto-normalizes `pan`, `isin`, `cin` to lowercase in [backend/models/Company.js](UnlistedHub-USM/backend/models/Company.js); axios clients in [UnlistedHub-USM/frontend/src/utils/api.js](UnlistedHub-USM/frontend/src/utils/api.js) and [nlistplanet-mobile/frontend/src/utils/api.js](nlistplanet-mobile/frontend/src/utils/api.js); price/date helpers in [UnlistedHub-USM/frontend/src/utils/helpers.js](UnlistedHub-USM/frontend/src/utils/helpers.js) and [nlistplanet-mobile/frontend/src/utils/helpers.js](nlistplanet-mobile/frontend/src/utils/helpers.js).
- Dev workflows: Backend `cd UnlistedHub-USM/backend && npm install && npm run dev` (nodemon on port 5001) or `npm start`; desktop `cd UnlistedHub-USM/frontend && npm install && npm start` (port 3000); mobile `cd nlistplanet-mobile/frontend && npm install && npm start`; health check at `GET /api/health`. No automated tests—validate via Postman/UI; ad-hoc test scripts: `node test-admin-api.js`, `node test-openai.js`, `node test-sms.js` from backend directory.
- Environment: Backend needs `MONGODB_URI`, `JWT_SECRET` (32+ chars), `FRONTEND_URL`, `CORS_ORIGINS`, `EMAIL_USER`, `EMAIL_PASSWORD`, `OPENAI_API_KEY` (for AI news features); optional: `CLOUDINARY_*` for image storage. Frontends use `REACT_APP_API_URL` (defaults to prod if absent). Never commit `.env`.
- Platform fee (hidden 2%): buyers pay 1.02×, sellers receive 0.98×. Use `calculateBuyerPays`, `calculateSellerGets`, `getPriceDisplay` from helpers; backend stores `buyerOfferedPrice`, `sellerReceivesPrice`, `platformFee` on listings/bids. Never surface the fee explicitly.
- Price display rules: SELL owner sees base price, others see buyer-pays; BUY owner sees base, others see seller-gets. Reuse helper outputs instead of manual math.
- Auth and security: Middleware order Helmet → CORS → rate limiting (300/15min global; 20/15min auth) → mongo-sanitize → xss-clean → compression. Passwords 12-128 chars alphanumeric with upper/lower/number; Argon2id hashing. Use `protect`, `authorize`, `optionalAuth` from auth middleware; frontend AuthContext sets Bearer tokens and enforces ~30m inactivity logout.
- API pattern: All routes under `/api`; register new routes in server.js and guard with middleware; add matching axios wrapper methods when exposing to UI. CORS origins configured via env; Render/Vercel previews are whitelisted.
- Data flows: Two-step accept flow for bids: pending → either party accepts first ('accepted', listing hidden) → second party accepts ('confirmed', verification codes generated) → admin closes transaction. Trading is anonymous (`@trader_xxx`); real identity is admin-only. See [TWO_STEP_ACCEPT_FLOW_UNIFIED.md](TWO_STEP_ACCEPT_FLOW_UNIFIED.md) for complete flow details.
- Frontend notes: React 18 (desktop) / 19 (mobile) with Tailwind. Mobile helpers include haptic helpers `haptic.*` and `triggerHaptic`. Keep pricing/date formatting centralized in helpers; avoid duplicating logic. ShareCardGenerator component exists in BOTH UIs—update both [desktop](UnlistedHub-USM/frontend/src/components/ShareCardGenerator.jsx) and [mobile](nlistplanet-mobile/frontend/src/components/ShareCardGenerator.jsx) versions when making changes; uses html2canvas to render investment highlight cards with company logos.
- AI features: Automated news pipeline in [utils/newsAI.js](UnlistedHub-USM/backend/utils/newsAI.js) generates Hindi Inshorts summaries (40-60 words) and DALL-E 3 images for missing thumbnails (runs every 30min via [utils/newsScheduler.js](UnlistedHub-USM/backend/utils/newsScheduler.js)). Admin can manually trigger via `/api/admin/news-ai/*` endpoints (process-ai, batch-process-ai, generate-image, generate-hindi). Requires `OPENAI_API_KEY`; optional `CLOUDINARY_*` for permanent image storage. See [INSHORTS_NEWS_AI_GUIDE.md](INSHORTS_NEWS_AI_GUIDE.md) for complete API docs.
- Scripts/ops: From backend run utility scripts: `npm run seed` ([seedCompanies.js](UnlistedHub-USM/backend/scripts/seedCompanies.js)), `node scripts/fetchNews.js`, `node scripts/createAdmin.js`, `node scripts/migrateUsernameHistory.js`, etc. Kill port 5001: `$processId = (Get-NetTCPConnection -LocalPort 5001).OwningProcess; Stop-Process -Id $processId -Force` (PowerShell). Deploy backend on Render (see [RENDER_AUTODEPLOY.md](UnlistedHub-USM/backend/RENDER_AUTODEPLOY.md)), frontends on Vercel with `CI=false` and `GENERATE_SOURCEMAP=false`.
- Critical don'ts: Do not expose the platform fee; do not weaken rate limiting/security; do not assume legacy `CompanyName` fields; do not bypass Argon2id or the password policy; treat backend changes as impacting both UIs; do not use require() (ES modules only).
- Helpful references: [PLATFORM_FEE_MODEL.md](PLATFORM_FEE_MODEL.md), [SECURITY_HARDENING_SUMMARY.md](SECURITY_HARDENING_SUMMARY.md), [NlistPlanet_System_Architecture_FULL.md](NlistPlanet_System_Architecture_FULL.md), [UNIFIED_WORKFLOW_GUIDE.md](UNIFIED_WORKFLOW_GUIDE.md), [SELL_FLOW_NEW_DESIGN.md](SELL_FLOW_NEW_DESIGN.md), [TWO_STEP_ACCEPT_FLOW_UNIFIED.md](TWO_STEP_ACCEPT_FLOW_UNIFIED.md), [INSHORTS_NEWS_AI_GUIDE.md](INSHORTS_NEWS_AI_GUIDE.md), [USERNAME_HISTORY_GUIDE.md](UnlistedHub-USM/backend/USERNAME_HISTORY_GUIDE.md), [SECURITY_FEATURES.md](UnlistedHub-USM/backend/SECURITY_FEATURES.md).
