# Copilot Instructions — NListPlanet / UnlistedHub

- Architecture: One shared backend in [UnlistedHub-USM/backend](UnlistedHub-USM/backend) serves both desktop [UnlistedHub-USM/frontend](UnlistedHub-USM/frontend) and mobile PWA [nlistplanet-mobile/frontend](nlistplanet-mobile/frontend); treat any docs claiming a separate mobile backend as legacy. Backend is ES modules only (no require).
- Must-read files: security and route wiring in [backend/server.js](UnlistedHub-USM/backend/server.js); auth helpers in [backend/middleware/auth.js](UnlistedHub-USM/backend/middleware/auth.js); listing schema and fee fields in [backend/models/Listing.js](UnlistedHub-USM/backend/models/Listing.js); company schema uses `name` in [backend/models/Company.js](UnlistedHub-USM/backend/models/Company.js); axios clients in [UnlistedHub-USM/frontend/src/utils/api.js](UnlistedHub-USM/frontend/src/utils/api.js) and [nlistplanet-mobile/frontend/src/utils/api.js](nlistplanet-mobile/frontend/src/utils/api.js); price/date helpers in [UnlistedHub-USM/frontend/src/utils/helpers.js](UnlistedHub-USM/frontend/src/utils/helpers.js) and [nlistplanet-mobile/frontend/src/utils/helpers.js](nlistplanet-mobile/frontend/src/utils/helpers.js).
- Dev workflows: Backend `cd UnlistedHub-USM/backend && npm install && npm run dev` (nodemon) or `npm start`; desktop `cd UnlistedHub-USM/frontend && npm install && npm start`; mobile `cd nlistplanet-mobile/frontend && npm install && npm start`; health check at `GET /api/health`. No automated tests—validate via Postman/UI; ad-hoc scripts live in backend/test-*.js.
- Environment: Backend needs `MONGODB_URI`, `JWT_SECRET` (32+ chars), `FRONTEND_URL`, `CORS_ORIGINS`, `EMAIL_USER`, `EMAIL_PASSWORD`; frontends use `REACT_APP_API_URL` (defaults to prod if absent). Never commit `.env`.
- Platform fee (hidden 2%): buyers pay 1.02×, sellers receive 0.98×. Use `calculateBuyerPays`, `calculateSellerGets`, `getPriceDisplay` from helpers; backend stores `buyerOfferedPrice`, `sellerReceivesPrice`, `platformFee` on listings/bids. Never surface the fee explicitly.
- Price display rules: SELL owner sees base price, others see buyer-pays; BUY owner sees base, others see seller-gets. Reuse helper outputs instead of manual math.
- Auth and security: Middleware order Helmet → CORS → rate limiting (300/15min global; 20/15min auth) → mongo-sanitize → xss-clean → compression. Passwords 12-128 chars alphanumeric with upper/lower/number; Argon2id hashing. Use `protect`, `authorize`, `optionalAuth` from auth middleware; frontend AuthContext sets Bearer tokens and enforces ~30m inactivity logout.
- API pattern: All routes under `/api`; register new routes in server.js and guard with middleware; add matching axios wrapper methods when exposing to UI. CORS origins configured via env; Render/Vercel previews are whitelisted.
- Data flows: Bid lifecycle pending → seller accept/reject/counter (tracked in `counterHistory`, limited rounds) → mutual accept creates Transaction → admin closes. Trading is anonymous (`@trader_xxx`); real identity is admin-only.
- Frontend notes: React 18 (desktop) / 19 (mobile) with Tailwind. Mobile helpers include haptic helpers `haptic.*` and `triggerHaptic`. Keep pricing/date formatting centralized in helpers; avoid duplicating logic.
- Scripts/ops: From backend run [scripts/seedCompanies.js](UnlistedHub-USM/backend/scripts/seedCompanies.js) and [scripts/fetchNews.js](UnlistedHub-USM/backend/scripts/fetchNews.js). Deploy backend on Render (see [RENDER_AUTODEPLOY.md](UnlistedHub-USM/backend/RENDER_AUTODEPLOY.md)), frontends on Vercel with `CI=false` and `GENERATE_SOURCEMAP=false`.
- Critical don'ts: Do not expose the platform fee; do not weaken rate limiting/security; do not assume legacy `CompanyName` fields; do not bypass Argon2id or the password policy; treat backend changes as impacting both UIs.
- Helpful references: [PLATFORM_FEE_MODEL.md](PLATFORM_FEE_MODEL.md), [SECURITY_HARDENING_SUMMARY.md](SECURITY_HARDENING_SUMMARY.md), [NlistPlanet_System_Architecture_FULL.md](NlistPlanet_System_Architecture_FULL.md), [UNIFIED_WORKFLOW_GUIDE.md](UNIFIED_WORKFLOW_GUIDE.md), [SELL_FLOW_NEW_DESIGN.md](SELL_FLOW_NEW_DESIGN.md), [USERNAME_HISTORY_GUIDE.md](UnlistedHub-USM/backend/USERNAME_HISTORY_GUIDE.md), [SECURITY_FEATURES.md](UnlistedHub-USM/backend/SECURITY_FEATURES.md).
